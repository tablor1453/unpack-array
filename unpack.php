<?php


    $data = [
        ['tahun_neraca' => "2015", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2015", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2016", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2016", "jumlah_bijih_SD" => 2000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2016", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2017", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2017", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2018", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2018", "jumlah_bijih_SD" => 7000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2018", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2015", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2015", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2016", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2016", "jumlah_bijih_SD" => 2000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2016", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2017", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2017", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2018", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2018", "jumlah_bijih_SD" => 7000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
        ['tahun_neraca' => "2018", "jumlah_bijih_SD" => 1000000, 'jumlah_bijih_CAD' => 20000000, "jumlah_logam_SD" => 1000000, 'jumlah_logam_CAD' => 20000000],
    ];

    $data2 = [
        ["tahun_neraca" => "2015", "jumlah_bijih_SD" => "32250000", "jumlah_bijih_CAD" => "0", "jumlah_logam_SD" => "3.87", "jumlah_logam_CAD" => "0"],
        ["tahun_neraca" => "2016", "jumlah_bijih_SD" => "32250000", "jumlah_bijih_CAD" => "0", "jumlah_logam_SD" => "3.87", "jumlah_logam_CAD" => "0"],
        ["tahun_neraca" => "2017", "jumlah_bijih_SD" => "32250000", "jumlah_bijih_CAD" => "0", "jumlah_logam_SD" => "3.87", "jumlah_logam_CAD" => "0"],
        ["tahun_neraca" => "2018", "jumlah_bijih_SD" => "32250000", "jumlah_bijih_CAD" => "0", "jumlah_logam_SD" => "3.87", "jumlah_logam_CAD" => "0"],
        ["tahun_neraca" => "2019", "jumlah_bijih_SD" => 32250000, "jumlah_bijih_CAD" => 0, "jumlah_logam_SD" => 3.87, "jumlah_logam_CAD" => 0]
    ];

   


    
    function unpackArray($dataRaw) {

        
        $dataArray = []; //Arrray for result
        $arrayKey = []; //Array for collect unique key on parameter

        foreach($dataRaw as $data) {
            if(!in_array($data['tahun_neraca'], $arrayKey)){
                $arrayKey[] = $data['tahun_neraca'];
            }
           
        }

        $length = count($arrayKey);

        foreach ($dataRaw as $data) {

            for ($i=0; $i < $length; $i++) {
               
                if($data['tahun_neraca'] == $arrayKey[$i]){
    
                    if(empty($dataArray)) {
                        // echo "masuk data awal \n"; //for check proses add new value if the first array value
                        $dataArray[$data['tahun_neraca']]['jumlah_bijih_SD'] = (float)$data['jumlah_bijih_SD'];
                        $dataArray[$data['tahun_neraca']]['jumlah_bijih_CAD'] = (float)$data['jumlah_bijih_CAD'];
                        $dataArray[$data['tahun_neraca']]['jumlah_logam_SD'] = (float)$data['jumlah_logam_SD'];
                        $dataArray[$data['tahun_neraca']]['jumlah_logam_CAD'] = (float)$data['jumlah_logam_CAD'];
                    }else{
                        if(!isset($dataArray[$data['tahun_neraca']])) {
                            // echo "tahun baru \n"; //for check proses add new value for next array value
                            $dataArray[$data['tahun_neraca']]['jumlah_bijih_SD'] = isset($data['jumlah_bijih_CAD']) ? $data['jumlah_bijih_SD'] : null;
                            $dataArray[$data['tahun_neraca']]['jumlah_bijih_CAD'] = isset($data['jumlah_bijih_CAD']) ? $data['jumlah_bijih_CAD'] : null;
                            $dataArray[$data['tahun_neraca']]['jumlah_logam_SD'] = isset($data['jumlah_logam_SD']) ? $data['jumlah_logam_SD'] : null;
                            $dataArray[$data['tahun_neraca']]['jumlah_logam_CAD'] = isset($data['jumlah_logam_CAD']) ? $data['jumlah_logam_CAD'] : null;
                            
                        }else{
                            // echo "jumlah nilai \n"; //for check proses increment array value
                            $dataArray[$data['tahun_neraca']]['jumlah_bijih_SD'] += (float)$data['jumlah_bijih_SD'];
                            $dataArray[$data['tahun_neraca']]['jumlah_bijih_CAD'] += (float)$data['jumlah_bijih_CAD'];
                            $dataArray[$data['tahun_neraca']]['jumlah_logam_SD'] += (float)$data['jumlah_logam_SD'];
                            $dataArray[$data['tahun_neraca']]['jumlah_logam_CAD'] += (float)$data['jumlah_logam_CAD'];
                        }
                    }
                }
            }
        }

        // print_r($arrayKey); //for check result arrayKey
        // print_r($dataArray); //for check result dataArray

        return $dataArray; //array result
    }

    //Output Type
    header('Content-Type => application/json');
    echo json_encode(unpackArray($data));

?>